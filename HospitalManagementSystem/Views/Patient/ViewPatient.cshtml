@using HMS.Application.DTO.Patient
@model PatientDto


<div class="container my-5">
    <div class="card shadow rounded-4 border">
        <!-- Card Header -->
        <div class="card-header bg-danger text-white text-center fs-4 fw-semibold">
            Patient Details
        </div>

        <!-- Card Body -->
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-6">
                    <p class="text-muted mb-1">Patient Code</p>
                    <p class="fw-medium">@Model.PatientCode</p>
                </div>

                <div class="col-md-6">
                    <p class="text-muted mb-1">Full Name</p>
                    <p class="fw-medium">@Model.FullName</p>
                </div>

                <div class="col-md-6">
                    <p class="text-muted mb-1">Gender</p>
                    <p class="fw-medium">@Model.Gender</p>
                </div>

                <div class="col-md-6">
                    <p class="text-muted mb-1">Date of Birth</p>
                    <p class="fw-medium">@Model.DateOfBirth.ToShortDateString()</p>
                </div>

                <div class="col-md-6">
                    <p class="text-muted mb-1">Email</p>
                    <p class="fw-medium">@Model.Email</p>
                </div>

                <div class="col-md-6">
                    <p class="text-muted mb-1">Contact Number</p>
                    <p class="fw-medium">@Model.ContactNumber</p>
                </div>

                @if (!string.IsNullOrEmpty(Model.AlternateContactNumber))
                {
                    <div class="col-md-6">
                        <p class="text-muted mb-1">Alternate Contact</p>
                        <p class="fw-medium">@Model.AlternateContactNumber</p>
                    </div>
                }

                <div class="col-12">
                    <p class="text-muted mb-1">Address</p>
                    <p class="fw-medium">@Model.Address, @Model.City, @Model.State - @Model.ZipCode</p>
                </div>

                @if (!string.IsNullOrEmpty(Model.BloodGroup))
                {
                    <div class="col-md-6">
                        <p class="text-muted mb-1">Blood Group</p>
                        <p class="fw-medium">@Model.BloodGroup</p>
                    </div>
                }

                @if (!string.IsNullOrEmpty(Model.EmergencyContactName))
                {
                    <div class="col-12">
                        <p class="text-muted mb-1">Emergency Contact</p>
                        <p class="fw-medium">
                            @Model.EmergencyContactName (@Model.RelationshipWithEmergencyContact) — @Model.EmergencyContactNumber
                        </p>
                    </div>
                }

                <div class="col-md-6">
                    <p class="text-muted mb-1">Created At</p>
                    <p class="fw-medium">@Model.CreatedAt.ToString("g")</p>
                </div>

                <div class="col-md-6">
                    <p class="text-muted mb-1">Updated At</p>
                    <p class="fw-medium">@(Model.UpdatedAt?.ToString("g") ?? "-")</p>
                </div>

                <div class="col-md-6">
                    <p class="text-muted mb-1">Status</p>
                    <span class="badge @(Model.IsActive ? "bg-success" : "bg-secondary")">
                        @(Model.IsActive ? "Active" : "Inactive")
                    </span>
                </div>
            </div>
        </div>

        <!-- Card Footer: Buttons -->
        <div class="card-footer d-flex flex-wrap gap-2">
            <a href="/User/AdminDashboard" class="btn btn-danger">← Back to List</a>

            <button id="addHistoryBtn" class="btn btn-danger">+ Add Medical History</button>
            <button id="addAllergyBtn" class="btn btn-danger">+ Add Allergy</button>
            <button id="viewHistoryBtn" class="btn btn-danger">👁 View Medical History</button>
            <button id="viewAllergiesBtn" class="btn btn-danger">👁 View Allergies</button>
            <button id="addInsuranceBtn" class="btn btn-danger">+ Add Insurance</button>
            <button id="toggleInsuranceBtn" data-patient-id="@Model.Id" class="btn btn-primary">Show / Hide Insurance</button>
        </div>
    </div>

    <!-- Medical History Table -->
    <div id="medicalHistorySection" class="mt-4 d-none">
        <div class="card shadow rounded-4 border">
            <div class="card-header bg-dark text-white text-center fs-5 fw-semibold">
                Patient Medical History
            </div>
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th>Condition</th>
                            <th>Diagnosis</th>
                            <th>Treatment</th>
                            <th>Medications</th>
                            <th>Date</th>
                            <th>Physician</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="medicalHistoryTableBody">
                        <!-- Rows dynamically appended -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Allergies Table -->
    <div id="allergiesTableContainer" class="mt-4 d-none">
        <div class="table-responsive">
            <table class="table table-bordered table-striped table-hover">
                <thead class="table-danger text-uppercase text-sm">
                    <tr>
                        <th>Allergen</th>
                        <th>Reaction</th>
                        <th>Notes</th>
                        <th>Created At</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody id="allergiesTableBody">
                    <!-- AJAX populated -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Insurance Table -->
    <div id="insuranceTableContainer" class="mt-4 d-none">
        <div class="table-responsive">
            <table class="table table-bordered table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>#</th>
                        <th>Provider Name</th>
                        <th>Policy Number</th>
                        <th>Start Date</th>
                        <th>End Date</th>
                        <th>Created At</th>
                        <th>Updated At</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="insuranceTableBody">
                    <!-- AJAX populated -->
                </tbody>
            </table>
        </div>
    </div>
</div>




<!-- Medical History Modal -->
<div class="modal fade" id="medicalHistoryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">

            <!-- Modal Header -->
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title text-center w-100">Add Medical History</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <!-- Modal Body -->
            <div class="modal-body">
                <form id="medicalHistoryForm">

                    <!-- Hidden PatientId -->
                    <input type="hidden" id="patientId" name="PatientId" value="@Model.Id" />

                    <div class="mb-3">
                        <label for="condition" class="form-label">Condition</label>
                        <input type="text" id="condition" name="Condition" class="form-control" required />
                    </div>

                    <div class="mb-3">
                        <label for="diagnosis" class="form-label">Diagnosis</label>
                        <input type="text" id="diagnosis" name="Diagnosis" class="form-control" />
                    </div>

                    <div class="mb-3">
                        <label for="treatment" class="form-label">Treatment</label>
                        <input type="text" id="treatment" name="Treatment" class="form-control" />
                    </div>

                    <div class="mb-3">
                        <label for="medications" class="form-label">Medications</label>
                        <input type="text" id="medications" name="Medications" class="form-control" />
                    </div>

                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes</label>
                        <textarea id="notes" name="Notes" class="form-control" rows="3"></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="recordDate" class="form-label">Record Date</label>
                        <input type="date" id="recordDate" name="RecordDate"
                               value="@DateTime.UtcNow.ToString("yyyy-MM-dd")"
                               class="form-control" />
                    </div>

                    <div class="mb-3">
                        <label for="attendingPhysician" class="form-label">Attending Physician</label>
                        <input type="text" id="attendingPhysician" name="AttendingPhysician" class="form-control" />
                    </div>

                    <div class="d-flex justify-content-end">
                        <button type="submit" class="btn btn-danger px-4">Save</button>
                    </div>

                    <p id="formMessage" class="text-center text-muted mt-3"></p>
                </form>
            </div>

        </div>
    </div>
</div>



<!-- Edit Medical History Modal -->
<div class="modal fade" id="editHistoryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-md modal-dialog-centered">
        <div class="modal-content">

            <!-- Modal Header -->
            <div class="modal-header bg-secondary text-white">
                <h5 class="modal-title w-100 text-center">Edit Medical History</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <!-- Modal Body -->
            <div class="modal-body">
                <form id="editHistoryForm">

                    <!-- Hidden History ID -->
                    <input type="hidden" id="editHistoryId" />

                    <div class="mb-3">
                        <label for="editCondition" class="form-label">Condition</label>
                        <input type="text" id="editCondition" class="form-control" />
                    </div>

                    <div class="mb-3">
                        <label for="editDiagnosis" class="form-label">Diagnosis</label>
                        <input type="text" id="editDiagnosis" class="form-control" />
                    </div>

                    <div class="mb-3">
                        <label for="editTreatment" class="form-label">Treatment</label>
                        <input type="text" id="editTreatment" class="form-control" />
                    </div>

                    <div class="mb-3">
                        <label for="editMedications" class="form-label">Medications</label>
                        <input type="text" id="editMedications" class="form-control" />
                    </div>

                    <div class="mb-3">
                        <label for="editNotes" class="form-label">Notes</label>
                        <textarea id="editNotes" class="form-control" rows="3"></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="editRecordDate" class="form-label">Record Date</label>
                        <input type="date" id="editRecordDate" class="form-control" />
                    </div>

                    <div class="mb-3">
                        <label for="editPhysician" class="form-label">Attending Physician</label>
                        <input type="text" id="editPhysician" class="form-control" />
                    </div>

                    <div class="d-flex justify-content-end gap-2">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-danger">Save</button>
                    </div>

                </form>
            </div>

        </div>
    </div>
</div>


<!-- Add Allergy Modal -->
<div class="modal fade" id="addAllergyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-md modal-dialog-centered">
        <div class="modal-content">

            <!-- Modal Header -->
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title w-100 text-center">Add Allergy</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <!-- Modal Body -->
            <div class="modal-body">
                <form id="addAllergyForm">

                    <!-- Hidden PatientId -->
                    <input type="hidden" id="allergyPatientId" value="@Model.Id" />

                    <div class="mb-3">
                        <label for="allergen" class="form-label">Allergen</label>
                        <input type="text" id="allergen" class="form-control" required />
                    </div>

                    <div class="mb-3">
                        <label for="reaction" class="form-label">Reaction</label>
                        <input type="text" id="reaction" class="form-control" required />
                    </div>

                    <div class="mb-3">
                        <label for="allergyNotes" class="form-label">Notes</label>
                        <textarea id="allergyNotes" class="form-control" rows="3"></textarea>
                    </div>

                    <div class="d-flex justify-content-end gap-2">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success">Add</button>
                    </div>

                </form>
            </div>

        </div>
    </div>
</div>

<!-- Edit Allergy Modal -->
<div class="modal fade" id="editAllergyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-md modal-dialog-centered">
        <div class="modal-content">

            <!-- Modal Header -->
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title w-100 text-center">Edit Allergy</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <!-- Modal Body -->
            <div class="modal-body">
                <form id="editAllergyForm">

                    <!-- Hidden IDs -->
                    <input type="hidden" id="editAllergyId" name="id" />
                    <input type="hidden" id="editPatientId" name="patientId" value="@Model.Id" />

                    <div class="mb-3">
                        <label for="editAllergen" class="form-label">Allergen</label>
                        <input type="text" id="editAllergen" name="allergen" class="form-control" required />
                    </div>

                    <div class="mb-3">
                        <label for="editReaction" class="form-label">Reaction</label>
                        <input type="text" id="editReaction" name="reaction" class="form-control" required />
                    </div>

                    <div class="mb-3">
                        <label for="editAllergyNotes" class="form-label">Notes</label>
                        <textarea id="editAllergyNotes" name="notes" rows="3" class="form-control"></textarea>
                    </div>

                    <div class="d-flex justify-content-end gap-2">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-danger">Save Changes</button>
                    </div>

                </form>
            </div>

        </div>
    </div>
</div>


<!-- Add Insurance Modal -->
<div class="modal fade" id="insuranceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">

            <!-- Modal Header -->
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title w-100 text-center">Add Insurance</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <!-- Modal Body -->
            <div class="modal-body">
                <form id="addInsuranceForm">

                    <!-- Hidden Patient Id -->
                    <input type="hidden" id="PatientId" name="PatientId" value="@Model.Id" />

                    <div class="mb-3">
                        <label for="ProviderName" class="form-label">Provider Name</label>
                        <input type="text" id="ProviderName" name="ProviderName" maxlength="100" class="form-control" required />
                    </div>

                    <div class="mb-3">
                        <label for="PolicyNumber" class="form-label">Policy Number</label>
                        <input type="text" id="PolicyNumber" name="PolicyNumber" maxlength="50" class="form-control" required />
                    </div>

                    <div class="mb-3">
                        <label for="StartDate" class="form-label">Start Date</label>
                        <input type="date" id="StartDate" name="StartDate" class="form-control" required />
                    </div>

                    <div class="mb-3">
                        <label for="EndDate" class="form-label">End Date</label>
                        <input type="date" id="EndDate" name="EndDate" class="form-control" required />
                    </div>

                    <div class="d-flex justify-content-end">
                        <button type="submit" class="btn btn-primary px-4">Save Insurance</button>
                    </div>

                </form>
            </div>

        </div>
    </div>
</div>

<!-- Edit Insurance Modal -->
<div id="editInsuranceModal" class="modal fade" tabindex="-1" aria-labelledby="editInsuranceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="editInsuranceModalLabel">Edit Insurance</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <form id="editInsuranceForm">
                    <input type="hidden" id="insuranceId">

                    <div class="mb-3">
                        <label class="form-label">Provider Name</label>
                        <input type="text" id="providerName" class="form-control" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Policy Number</label>
                        <input type="text" id="policyNumber" class="form-control" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Start Date</label>
                        <input type="date" id="startDate" class="form-control" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">End Date</label>
                        <input type="date" id="endDate" class="form-control" required>
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="saveInsuranceChanges" class="btn btn-success">Save Changes</button>
            </div>

        </div>
    </div>
</div>




<script src="/js/Patient/ViewPatient.js"></script>