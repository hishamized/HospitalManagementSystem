<h1 class="text-3xl font-bold mb-6">Patient Management</h1>

<!-- Add Patient Button -->
<button id="addPatientBtn" class="mb-4 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded">Add Patient</button>

<!-- Patient Table -->
<div class="overflow-x-auto">
    <table id="patientTable" class="min-w-full border border-gray-700 bg-gray-800 shadow rounded text-gray-200">
        <thead class="bg-gray-900 text-white">
            <tr>
                <th class="px-4 py-2">Patient Code</th>
                <th class="px-4 py-2">Full Name</th>
                <th class="px-4 py-2">Gender</th>
                <th class="px-4 py-2">DOB</th>
                <th class="px-4 py-2">Email</th>
                <th class="px-4 py-2">Contact</th>
                <th class="px-4 py-2">Address</th>
                <th class="px-4 py-2">City</th>
                <th class="px-4 py-2">State</th>
                <th class="px-4 py-2">Zip</th>
                <th class="px-4 py-2">Blood Group</th>
                <th class="px-4 py-2">Emergency Contact</th>
                <th class="px-4 py-2">Actions</th>
            </tr>
        </thead>
        <tbody class="bg-gray-800"></tbody>
    </table>
</div>

<!-- Add Patient Modal -->
<div id="addPatientModal" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center hidden">
    <div class="bg-gray-900 text-gray-200 p-6 rounded w-3/4 max-h-[90vh] overflow-y-auto shadow-lg">
        <h2 class="text-2xl mb-4 font-bold">Add Patient</h2>
        <div class="grid grid-cols-2 gap-4">
            <input type="text" id="fullName" placeholder="Full Name" class="border border-gray-700 p-2 rounded bg-gray-800 text-gray-200" />
            <input type="text" id="gender" placeholder="Gender" class="border border-gray-700 p-2 rounded bg-gray-800 text-gray-200" />
            <input type="date" id="dob" class="border border-gray-700 p-2 rounded bg-gray-800 text-gray-200" />
            <input type="email" id="email" placeholder="Email" class="border border-gray-700 p-2 rounded bg-gray-800 text-gray-200" />
            <input type="text" id="contactNumber" placeholder="Contact Number" class="border border-gray-700 p-2 rounded bg-gray-800 text-gray-200" />
            <input type="text" id="alternateContactNumber" placeholder="Alternate Contact" class="border border-gray-700 p-2 rounded bg-gray-800 text-gray-200" />
            <input type="text" id="address" placeholder="Address" class="border border-gray-700 p-2 rounded bg-gray-800 text-gray-200" />
            <input type="text" id="city" placeholder="City" class="border border-gray-700 p-2 rounded bg-gray-800 text-gray-200" />
            <input type="text" id="state" placeholder="State" class="border border-gray-700 p-2 rounded bg-gray-800 text-gray-200" />
            <input type="text" id="zipCode" placeholder="Zip Code" class="border border-gray-700 p-2 rounded bg-gray-800 text-gray-200" />
            <input type="text" id="bloodGroup" placeholder="Blood Group" class="border border-gray-700 p-2 rounded bg-gray-800 text-gray-200" />
            <input type="text" id="emergencyContactName" placeholder="Emergency Contact Name" class="border border-gray-700 p-2 rounded bg-gray-800 text-gray-200" />
            <input type="text" id="emergencyContactNumber" placeholder="Emergency Contact Number" class="border border-gray-700 p-2 rounded bg-gray-800 text-gray-200" />
            <input type="text" id="relationshipWithEmergencyContact" placeholder="Relationship with Emergency Contact" class="border border-gray-700 p-2 rounded bg-gray-800 text-gray-200" />
        </div>
        <div class="mt-4 flex justify-end gap-2">
            <button id="closeAddModal" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">Cancel</button>
            <button id="savePatientBtn" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Save</button>
        </div>
    </div>
</div>

<!-- Edit Patient Modal -->
<div id="editPatientModal" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center hidden">
    <div class="bg-gray-900 text-gray-200 p-6 rounded w-3/4 max-h-[90vh] overflow-y-auto shadow-lg">
        <h2 class="text-2xl mb-4 font-bold">Edit Patient</h2>
        <input type="hidden" id="editId" />
        <div class="grid grid-cols-2 gap-4">
            <input type="text" id="editFullName" placeholder="Full Name" class="border border-gray-700 p-2 rounded bg-gray-800 text-gray-200" />
            <input type="text" id="editGender" placeholder="Gender" class="border border-gray-700 p-2 rounded bg-gray-800 text-gray-200" />
            <input type="date" id="editDob" class="border border-gray-700 p-2 rounded bg-gray-800 text-gray-200" />
            <input type="email" id="editEmail" placeholder="Email" class="border border-gray-700 p-2 rounded bg-gray-800 text-gray-200" />
            <input type="text" id="editContactNumber" placeholder="Contact Number" class="border border-gray-700 p-2 rounded bg-gray-800 text-gray-200" />
            <input type="text" id="editAlternateContactNumber" placeholder="Alternate Contact" class="border border-gray-700 p-2 rounded bg-gray-800 text-gray-200" />
            <input type="text" id="editAddress" placeholder="Address" class="border border-gray-700 p-2 rounded bg-gray-800 text-gray-200" />
            <input type="text" id="editCity" placeholder="City" class="border border-gray-700 p-2 rounded bg-gray-800 text-gray-200" />
            <input type="text" id="editState" placeholder="State" class="border border-gray-700 p-2 rounded bg-gray-800 text-gray-200" />
            <input type="text" id="editZipCode" placeholder="Zip Code" class="border border-gray-700 p-2 rounded bg-gray-800 text-gray-200" />
            <input type="text" id="editBloodGroup" placeholder="Blood Group" class="border border-gray-700 p-2 rounded bg-gray-800 text-gray-200" />
            <input type="text" id="editEmergencyContactName" placeholder="Emergency Contact Name" class="border border-gray-700 p-2 rounded bg-gray-800 text-gray-200" />
            <input type="text" id="editEmergencyContactNumber" placeholder="Emergency Contact Number" class="border border-gray-700 p-2 rounded bg-gray-800 text-gray-200" />
            <input type="text" id="editRelationshipWithEmergencyContact" placeholder="Relationship with Emergency Contact" class="border border-gray-700 p-2 rounded bg-gray-800 text-gray-200" />
        </div>
        <div class="mt-4 flex justify-end gap-2">
            <button id="closeEditModal" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">Cancel</button>
            <button id="updatePatientBtn" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Update</button>
        </div>
    </div>
</div>


<!-- jQuery Script -->
<script>
    $(document).ready(function() {

        function handleAjaxError(xhr, status, error) {
            console.error("AJAX Error:", status, error);
            if (xhr.responseText) {
                console.error("Server response:", xhr.responseText);
                alert("Server error: " + xhr.responseText);
            } else {
                alert("AJAX error: " + status + " - " + error);
            }
        }

        function loadPatients() {
            $.ajax({
                url: "/Patient/GetAllPatients",
                type: "GET",
                success: function(data) {
                    $("#patientTable tbody").empty();
                    data.forEach(p => {
                        let dob = new Date(p.dateOfBirth).toLocaleDateString();
                        $("#patientTable tbody").append(`
                            <tr class="border-b hover:bg-gray-900">
                                <td class="px-2 py-1">${p.patientCode}</td>
                                <td class="px-2 py-1">${p.fullName}</td>
                                <td class="px-2 py-1">${p.gender}</td>
                                <td class="px-2 py-1">${dob}</td>
                                <td class="px-2 py-1">${p.email}</td>
                                <td class="px-2 py-1">${p.contactNumber}</td>
                                <td class="px-2 py-1">${p.address}</td>
                                <td class="px-2 py-1">${p.city ?? ''}</td>
                                <td class="px-2 py-1">${p.state ?? ''}</td>
                                <td class="px-2 py-1">${p.zipCode ?? ''}</td>
                                <td class="px-2 py-1">${p.bloodGroup ?? ''}</td>
                                <td class="px-2 py-1">${p.emergencyContactName ?? ''} - ${p.emergencyContactNumber ?? ''} (${p.relationshipWithEmergencyContact ?? ''})</td>
                                <td class="px-2 py-1">
                                    <button class='edit-btn bg-yellow-500 text-white px-2 py-1 rounded' data-id='${p.id}'>Edit</button>
                                    <button class='delete-btn bg-red-500 text-white px-2 py-1 rounded' data-id='${p.id}'>Delete</button>
                                    <button class='view-btn bg-red-500 text-white px-2 py-1 rounded' data-id='${p.id}'>View</button>
                                </td>
                            </tr>
                        `);
                    });
                },
                error: handleAjaxError
            });
        }

        // Show Add Modal
        $("#addPatientBtn").click(() => $("#addPatientModal").removeClass("hidden"));
        $("#closeAddModal").click(() => $("#addPatientModal").addClass("hidden"));

        // Save Patient
        $("#savePatientBtn").click(function() {
            var dto = {
                FullName: $("#fullName").val(),
                Gender: $("#gender").val(),
                DateOfBirth: $("#dob").val(),
                Email: $("#email").val(),
                ContactNumber: $("#contactNumber").val(),
                AlternateContactNumber: $("#alternateContactNumber").val(),
                Address: $("#address").val(),
                City: $("#city").val(),
                State: $("#state").val(),
                ZipCode: $("#zipCode").val(),
                BloodGroup: $("#bloodGroup").val(),
                EmergencyContactName: $("#emergencyContactName").val(),
                EmergencyContactNumber: $("#emergencyContactNumber").val(),
                RelationshipWithEmergencyContact: $("#relationshipWithEmergencyContact").val(),
            };

            $.ajax({
                url: "/Patient/CreatePatient",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(dto),
                success: function() {
                    $("#addPatientModal").addClass("hidden");
                    loadPatients();
                },
                error: handleAjaxError
            });
        });

        // Show Edit Modal
        $(document).on("click", ".edit-btn", function() {
            var id = $(this).data("id");
            $.ajax({
                url: `/Patient/GetPatientById?id=${id}`,
                type: "GET",
                success: function(p) {
                    $("#editId").val(p.id);
                    $("#editFullName").val(p.fullName);
                    $("#editGender").val(p.gender);
                    $("#editDob").val(p.dateOfBirth.split('T')[0]);
                    $("#editEmail").val(p.email);
                    $("#editContactNumber").val(p.contactNumber);
                    $("#editAlternateContactNumber").val(p.alternateContactNumber);
                    $("#editAddress").val(p.address);
                    $("#editCity").val(p.city);
                    $("#editState").val(p.state);
                    $("#editZipCode").val(p.zipCode);
                    $("#editBloodGroup").val(p.bloodGroup);
                    $("#editEmergencyContactName").val(p.emergencyContactName);
                    $("#editEmergencyContactNumber").val(p.emergencyContactNumber);
                    $("#editRelationshipWithEmergencyContact").val(p.relationshipWithEmergencyContact);
                    $("#editPatientModal").removeClass("hidden");
                },
                error: handleAjaxError
            });
        });
        $("#closeEditModal").click(() => $("#editPatientModal").addClass("hidden"));

        // Update Patient
        $("#updatePatientBtn").click(function() {
            var dto = {
                Id: $("#editId").val(),
                FullName: $("#editFullName").val(),
                Gender: $("#editGender").val(),
                DateOfBirth: $("#editDob").val(),
                Email: $("#editEmail").val(),
                ContactNumber: $("#editContactNumber").val(),
                AlternateContactNumber: $("#editAlternateContactNumber").val(),
                Address: $("#editAddress").val(),
                City: $("#editCity").val(),
                State: $("#editState").val(),
                ZipCode: $("#editZipCode").val(),
                BloodGroup: $("#editBloodGroup").val(),
                EmergencyContactName: $("#editEmergencyContactName").val(),
                EmergencyContactNumber: $("#editEmergencyContactNumber").val(),
                RelationshipWithEmergencyContact: $("#editRelationshipWithEmergencyContact").val(),
            };

            $.ajax({
                url: "/Patient/UpdatePatient",
                type: "PUT",
                contentType: "application/json",
                data: JSON.stringify(dto),
                success: function() {
                    $("#editPatientModal").addClass("hidden");
                    loadPatients();
                },
                error: handleAjaxError
            });
        });

        // Delete Patient
        $(document).on("click", ".delete-btn", function() {
            var id = $(this).data("id");
            if(confirm("Are you sure?")) {
                $.ajax({
                    url: `/Patient/DeletePatient?id=${id}`,
                    type: "DELETE",
                    success: loadPatients,
                    error: handleAjaxError
                });
            }
        });

        loadPatients();

          // Handle click on dynamically generated buttons
            $(document).on('click', '.view-btn', function () {
                var patientId = $(this).data('id');
                window.location.href = '/Patient/ViewPatient?id=' + patientId;
            });

    });
</script>